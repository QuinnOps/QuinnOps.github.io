###### #这是一篇关于安装k8s的文章

安装准备：三台机器，配置至少2c2g

192.168.31.202（master）

192.168.31.203

192.168.31.204

所有机器禁用防火墙、selinux、swap

```shell
systemctl stop firewalld & systemctl disable firewalld

setenforce 0
vi /etc/selinux/config
SELINUX=disabled

swapoff -a
vi /etc/fstab，注释掉swap
```

添加k8s源（可以科学上网跳过）

```shell
cat <<EOF > /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF

```

安装ipset ipvsadm

```shell
yum install -y ipset ipvsadm
```

安装docker并自启

```
yum install docker
systemctl start docker & systemctl enable docker
```

配置docker源

```
cat >>/etc/docker/daemon.json<<"EOF"
{
"registry-mirrors": ["http://hub-mirror.c.163.com"]
}
EOF

systemctl restart docker
```

安装三件套，设置kubelet自启

```shell
yum install -y kubectl-1.13.0 kubeadm-1.13.0 kubectl-1.13.0

systemctl enable kubelet
```

kube-proxy开启ipvs

```shell
cat >>/etc/sysctl.d/k8s.conf<<"EOF"
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
modprobe br_netfilter
EOF

sysctl -p /etc/sysctl.d/k8s.conf

cat > /etc/sysconfig/modules/ipvs.modules <<EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF

chmod 755 /etc/sysconfig/modules/ipvs.modules && bash /etc/sysconfig/modules/ipvs.modules && lsmod | grep -e ip_vs -e nf_conntrack_ipv4
```

修改hostname

```
hostnamectl set-hostname XXXX
```

至此，三台机器相同的配置完成



下面初始化Master节点

```
kubeadm init --kubernetes-version=v1.13.0 --apiserver-advertise-address=192.168.31.202 --pod-network-cidr=192.168.0.0/16 --service-cidr=172.16.0.0/16
```

如果出现timeout是因为docker无法自动获取到images导致的，可以两种方式解决

​		A、手动去pull并修改标签

​		B、修改docker源的方式来解决

手动pull images

```
docker pull mirrorgooglecontainers/kube-apiserver:v1.13.0
docker pull mirrorgooglecontainers/kube-controller-manager:v1.13.0
docker pull mirrorgooglecontainers/kube-scheduler:v1.13.0
docker pull mirrorgooglecontainers/kube-proxy:v1.13.0
docker pull mirrorgooglecontainers/pause:3.1
docker pull mirrorgooglecontainers/etcd:3.2.24
docker pull coredns/coredns:1.2.6
docker tag mirrorgooglecontainers/kube-proxy:v1.13.0  k8s.gcr.io/kube-proxy:v1.13.0
docker tag mirrorgooglecontainers/kube-scheduler:v1.13.0 k8s.gcr.io/kube-scheduler:v1.13.0
docker tag mirrorgooglecontainers/kube-apiserver:v1.13.0 k8s.gcr.io/kube-apiserver:v1.13.0
docker tag mirrorgooglecontainers/kube-controller-manager:v1.13.0 k8s.gcr.io/kube-controller-manager:v1.13.0
docker tag mirrorgooglecontainers/etcd:3.2.24  k8s.gcr.io/etcd:3.2.24
docker tag coredns/coredns:1.2.6 k8s.gcr.io/coredns:1.2.6
docker tag mirrorgooglecontainers/pause:3.1  k8s.gcr.io/pause:3.1
```

初始化成功后会生成worker加入集群的指令  在worker节点上执行即可

```
kubeadm join 192.168.31.202:6443 --token f33uwo.4qu4khi3nn6wuon2 --discovery-token-ca-cert-hash sha256:758c34bd065b6fb3c3ae3840d0cf6667204673c5cf6ce9391567120957e8e201
```

执行如下指令

```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

这时候输入kubectl get cs 就可以查看服务的运行情况，确保都在正常运行

安装network addon(采用官方推荐的flannel方案，其中pod网段必须与之前init的时候设置的pod-network-cidr一致)

```
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml$ kubectl apply -f kube-flannel.yml
```

将worker join至master 

至此集群已搭建完毕，这时候可以通过kubectl get nodes来查看各节点运行情况
